name: Build component
'on':
  workflow_call:
    inputs:
      name:
        required: true
        type: string
      env_group:
        required: true
        type: string
      env:
        required: true
        type: string
      component:
        required: true
        type: string
      registry_ns:
        required: true
        type: string
    secrets:
      do_token:
        required: true
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Git Checkout
      uses: actions/checkout@v3
    - name: Set commit SHA
      run: echo SHORT_SHA=$(echo ${{github.sha}} | cut -c 1-8) >> $GITHUB_ENV
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    - name: Login to DOCR
      uses: docker/login-action@v1
      with:
        registry: registry.digitalocean.com
        username: ${{ secrets.do_token }}
        password: ${{ secrets.do_token }}
    - name: Build
      uses: docker/build-push-action@v3
      with:
        context: ./${{ inputs.component }}
        pull: true
        push: false
        load: true
        tags: registry.digitalocean.com/${{ inputs.registry_ns }}/${{ inputs.name
          }}-${{ inputs.component }}:${{ env.SHORT_SHA }},registry.digitalocean.com/${{
          inputs.registry_ns }}/${{ inputs.name }}-${{ inputs.component }}:${{ inputs.env
          }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    - name: Pushing image to DOCR
      run: docker push -a registry.digitalocean.com/${{ inputs.registry_ns }}/${{
        inputs.name }}-${{ inputs.component }}
